<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AITRICS 2026 Dr.Answer 3.0 | Master Roadmap</title>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;800&family=Pretendard:wght@400;600;800&display=swap");

      :root {
        --bg: #030406;
        --surface: #0b0d12;
        --border: #1e222d;
        --text-p: #f8fafc;
        --text-s: #94a3b8;
        --data: #00d1ff;
        --ai: #a855f7;
        --svc: #f43f5e;
        --reg: #fbbf24;
        --done: #10b981;
        --danger: #fb7185;
        --radius: 16px;
      }
      * { box-sizing: border-box; }
      body {
        font-family: "Pretendard", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
        background: var(--bg);
        color: var(--text-p);
        margin: 0;
        padding: 22px;
      }
      .container { max-width: 1760px; margin: 0 auto; }

      header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 14px;
        border-bottom: 1px solid var(--border);
        padding-bottom: 14px;
        margin-bottom: 12px;
      }
      .h-title { margin: 0; font-size: 22px; letter-spacing: 0.2px; }
      .h-sub { margin: 6px 0 0 0; color: var(--text-s); font-size: 13px; }
      .right { display: flex; flex-direction: column; gap: 10px; align-items: flex-end; min-width: 320px; }
      .row { display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
      .badge {
        font-family: "JetBrains Mono";
        font-size: 10px;
        font-weight: 900;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.14);
        background: #161b22;
        color: var(--text-s);
        white-space: nowrap;
      }
      .badge.on {
        color: #001b12;
        background: rgba(16,185,129,0.14);
        border-color: rgba(16,185,129,0.35);
      }
      .badge.warn {
        color: #2a1600;
        background: rgba(251,191,36,0.12);
        border-color: rgba(251,191,36,0.32);
      }
      .btn {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.02);
        color: var(--text-p);
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 12px;
        font-weight: 900;
        cursor: pointer;
      }
      .btn:hover { background: rgba(255,255,255,0.04); }
      .btn.primary { border-color: rgba(56,189,248,0.25); }
      .btn.danger { border-color: rgba(251,113,133,0.35); }

      .total-stat { text-align: right; }
      .total-label {
        font-size: 12px;
        color: var(--text-s);
        font-weight: 900;
        letter-spacing: 1px;
      }
      .total-percent { font-family: "JetBrains Mono"; font-size: 40px; font-weight: 800; color: var(--data); }

      /* ===== 4ê°œ í° íƒ­ ìœ ì§€ ===== */
      .nav { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 14px 0; }
      .nav a {
        text-decoration: none;
        color: var(--text-p);
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.02);
        padding: 8px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 900;
      }
      .nav a:hover { background: rgba(255,255,255,0.04); }

      .section-title {
        font-size: 14px;
        font-weight: 900;
        color: var(--text-s);
        margin: 18px 0 10px 0;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 14px;
        margin-bottom: 12px;
      }

      /* ===== ìƒë‹¨ 4ê°œ ì§„í–‰í˜„í™© ê³ ì • í‘œì‹œ ===== */
      .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
      .p-card {
        background: rgba(255,255,255,0.02);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
      }
      .p-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
      .p-name { font-size: 12.5px; font-weight: 900; }
      .p-meta { font-family: "JetBrains Mono"; font-size: 11px; color: var(--text-s); text-align: right; white-space: nowrap; }
      .p-bar {
        margin-top: 10px;
        height: 10px;
        border-radius: 999px;
        overflow: hidden;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.06);
      }
      .p-fill { height: 100%; }
      .p-foot { margin-top: 10px; display: flex; justify-content: space-between; gap: 10px; align-items: center; }
      .pill {
        font-family: "JetBrains Mono";
        font-size: 10px;
        font-weight: 900;
        padding: 3px 7px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        background: #161b22;
        color: var(--text-s);
        white-space: nowrap;
      }

      @media (max-width: 1200px) {
        .grid-4 { grid-template-columns: repeat(2, 1fr); }
        .right { align-items: flex-start; }
        .total-stat { text-align: left; }
      }
      @media (max-width: 760px) {
        .grid-4 { grid-template-columns: 1fr; }
        body { padding: 14px; }
        header { align-items: flex-start; }
      }

      /* ===== KPI ===== */
      .kpi-wrap { overflow-x: auto; }
      table.kpi {
        width: 100%;
        min-width: 820px;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255,255,255,0.01);
      }
      table.kpi th, table.kpi td {
        border: 1px solid var(--border);
        padding: 10px;
        font-size: 12px;
        vertical-align: top;
      }
      table.kpi th {
        background: rgba(255,255,255,0.03);
        color: var(--text-s);
        font-weight: 900;
        font-size: 11px;
        letter-spacing: 0.4px;
        text-align: left;
        white-space: nowrap;
      }

      /* ===== Gantt (ì›”/ì£¼ í™•ì¥) ===== */
      .timeline-card { overflow-x: auto; }
      .gantt-wrap { overflow-x: auto; }
      table.gantt {
        width: 100%;
        min-width: 1100px;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255,255,255,0.01);
      }
      table.gantt th, table.gantt td {
        border: 1px solid var(--border);
        padding: 10px;
        font-size: 11px;
        vertical-align: middle;
        white-space: nowrap;
      }
      table.gantt th {
        background: rgba(255,255,255,0.03);
        color: var(--text-s);
        font-weight: 900;
        font-size: 10px;
        letter-spacing: 0.4px;
        text-align: left;
      }
      .gantt-head-row th { text-align: center; }
      .gantt-left { min-width: 240px; }
      .g-cell { width: 64px; height: 42px; position: relative; }
      .g-tick { color: var(--text-s); font-family: "JetBrains Mono"; font-size: 10px; }
      .g-bar {
        position: absolute;
        left: 6px; right: 6px;
        height: 18px;
        top: 50%; transform: translateY(-50%);
        border-radius: 8px;
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.08);
        overflow: hidden;
      }
      .g-fill { height: 100%; width: 0%; }
      .g-label {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .g-title { font-weight: 900; }
      .g-meta { font-family: "JetBrains Mono"; color: var(--text-s); font-size: 10px; }

      /* ===== Filters ===== */
      .filters { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
      .seg { display: flex; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: rgba(255,255,255,0.02); }
      .seg button { border: 0; background: transparent; color: var(--text-s); padding: 8px 10px; font-size: 12px; font-weight: 900; cursor: pointer; }
      .seg button.active { color: var(--text-p); background: rgba(255,255,255,0.06); }
      .select, .input { border: 1px solid var(--border); background: rgba(255,255,255,0.02); color: var(--text-p); border-radius: 10px; padding: 8px 10px; font-size: 12px; font-weight: 800; outline: none; }
      .chipbar { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; margin-top: 10px; }
      .chip { border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.02); color: var(--text-s); border-radius: 999px; padding: 6px 10px; font-size: 11px; font-weight: 900; cursor: pointer; user-select: none; }
      .chip.on { color: var(--text-p); border-color: rgba(56,189,248,0.25); background: rgba(56,189,248,0.08); }

      /* ===== WBS ===== */
      .wbs-wrap { overflow-x: auto; }
      table.wbs {
        width: 100%;
        min-width: 1480px;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255,255,255,0.01);
      }
      table.wbs th, table.wbs td {
        border: 1px solid var(--border);
        padding: 10px;
        font-size: 12px;
        vertical-align: top;
      }
      table.wbs th {
        background: rgba(255,255,255,0.03);
        color: var(--text-s);
        font-weight: 900;
        font-size: 11px;
        letter-spacing: 0.4px;
        text-align: left;
        white-space: nowrap;
      }
      .dept-row td { background: rgba(255,255,255,0.02); font-weight: 900; color: var(--text-p); font-size: 12px; }
      .dept-tag { display: inline-block; font-size: 10px; font-weight: 900; color: #000; padding: 3px 8px; border-radius: 6px; margin-right: 8px; }
      .cb { width: 18px; height: 18px; accent-color: var(--done); cursor: pointer; }
      .mono { font-family: "JetBrains Mono"; }
      .idcell { white-space: nowrap; }
      .steps { color: var(--text-s); font-size: 11px; line-height: 1.45; }
      .stepline { display: flex; gap: 8px; align-items: flex-start; margin: 3px 0; }
      .wtag { font-family: "JetBrains Mono"; font-size: 10px; font-weight: 900; padding: 2px 7px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03); color: var(--text-p); white-space: nowrap; flex-shrink: 0; }
      .outtag { display: inline-block; border: 1px solid rgba(255,255,255,0.1); background: #161b22; color: var(--text-s); font-size: 10px; font-weight: 900; padding: 3px 7px; border-radius: 8px; white-space: nowrap; }
      .duetag { display: block; font-family: "JetBrains Mono"; font-size: 12px; font-weight: 900; color: var(--reg); white-space: nowrap; }
      .duemeta { display: block; margin-top: 4px; font-size: 10.5px; color: var(--text-s); white-space: nowrap; }
      .doneRow { background: rgba(16,185,129,0.03); }
      .doneText { color: var(--done); text-decoration: line-through; opacity: 0.78; }

      /* Step UI */
      .scb { width: 14px; height: 14px; margin-top: 1px; accent-color: var(--done); cursor: pointer; }
      .wtpill {
        font-family: "JetBrains Mono";
        font-size: 10px;
        font-weight: 900;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        background: #161b22;
        color: var(--text-s);
        white-space: nowrap;
      }
      .datepill {
        font-family: "JetBrains Mono";
        font-size: 10px;
        font-weight: 900;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.02);
        color: rgba(148,163,184,0.9);
        white-space: nowrap;
      }

      /* ì¸ë¼ì¸ í¸ì§‘ */
      .editable[contenteditable="true"] {
        padding: 2px 4px;
        border-radius: 6px;
        border: 1px dashed rgba(56,189,248,0.4);
        background: rgba(56,189,248,0.06);
        outline: none;
      }

      /* Reg */
      .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
      @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } }
      table.dark {
        width: 100%;
        border-collapse: collapse;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(255,255,255,0.01);
      }
      table.dark th, table.dark td { border: 1px solid var(--border); padding: 10px; font-size: 12px; vertical-align: top; }
      table.dark th { background: rgba(255,255,255,0.03); color: var(--text-s); font-weight: 900; font-size: 11px; letter-spacing: 0.4px; text-align: left; }

      /* ì—°ë§(12ì›”) ë¯¸ì™„ Task ê°•ì¡° */
      .year-end-risk { background: rgba(251,113,133,0.1) !important; }
      .year-end-risk td { border-color: rgba(251,113,133,0.35); }
      .risk-badge {
        display: inline-block;
        margin-left: 8px;
        padding: 3px 7px;
        font-size: 10px;
        font-weight: 900;
        border-radius: 999px;
        color: #3b0a0a;
        background: rgba(251,113,133,0.25);
        border: 1px solid rgba(251,113,133,0.45);
        white-space: nowrap;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <div>
          <h1 class="h-title">
            AITRICS <span style="font-weight: 300">2026 Dr.Answer 3.0 Master</span>
          </h1>
          <p class="h-sub">ì—°ê°„-ë°˜ê¸°-ë¶„ê¸°-ì›”-ì£¼ì°¨ í•„í„° ê¸°ë°˜ WBS ëŒ€ì‹œë³´ë“œ (Step ê°€ì¤‘ì¹˜/ì™„ë£Œì¼/Step ê¸°ë°˜ Gantt)</p>
        </div>

        <div class="right">
          <div class="row">
            <span class="badge" id="mode-badge">READ-ONLY</span>
            <span class="badge warn" id="save-badge">NOT SAVED</span>
            <button class="btn primary" id="edit-btn">í¸ì§‘</button>
            <button class="btn" id="save-btn" style="display: none">ì €ì¥</button>
            <button class="btn danger" id="exit-btn" style="display: none">ì¢…ë£Œ</button>
          </div>

          <div class="row" id="pw-row" style="display: none">
            <input class="input" id="pw-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸(1234)" style="min-width: 160px" />
            <button class="btn primary" id="pw-ok">í™•ì¸</button>
            <button class="btn" id="pw-cancel">ì·¨ì†Œ</button>
          </div>

          <div class="total-stat">
            <div class="total-label">TOTAL PROGRESS</div>
            <div class="total-percent" id="total-val">0%</div>
          </div>
        </div>
      </header>

      <div class="nav">
        <a href="#kpi">KPI ìŠ¤ëƒ…ìƒ·</a>
        <a href="#timeline">ì „ëµ íƒ€ì„ë¼ì¸</a>
        <a href="#wbs">ì£¼ì°¨ WBS</a>
        <a href="#reg">ê¸°ëŠ¥ë¶„ë¦¬Â·ì¸í—ˆê°€</a>
      </div>

      <div class="section-title"><span>ğŸ“</span> PROGRESS OVERVIEW (STEP-WEIGHTED)</div>
      <div class="card">
        <div class="grid-4" id="overview-grid"></div>
      </div>

      <div id="kpi" class="section-title"><span>ğŸ“Œ</span> KPI ìŠ¤ëƒ…ìƒ·</div>
      <div class="card kpi-wrap">
        <table class="kpi" id="kpi-table">
          <thead>
            <tr>
              <th style="width: 38%">KPI</th>
              <th style="width: 14%">ì§„í–‰(%)</th>
              <th style="width: 18%">DUE</th>
              <th style="width: 30%">ë‹´ë‹¹/ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody id="kpi-body"></tbody>
        </table>
      </div>

      <div id="timeline" class="section-title"><span>ğŸ—“ï¸</span> EXECUTION GANTT (MONTH / WEEK)</div>
      <div class="card">
        <div class="filters" style="justify-content: space-between; gap: 12px;">
          <div class="seg" aria-label="gantt view">
            <button class="active" data-gview="month">ì›”</button>
            <button data-gview="week">ì£¼</button>
          </div>
          <div class="row">
            <span class="badge" id="gantt-hint">STEP ê¸°ë°˜ ì§„í–‰ë¥ ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤</span>
          </div>
        </div>
      </div>
      <div class="card gantt-wrap">
        <table class="gantt" id="gantt-table">
          <thead id="gantt-head"></thead>
          <tbody id="gantt-body"></tbody>
        </table>
      </div>

      <div id="wbs" class="section-title"><span>ğŸ”</span> MICRO-WBS: WEEKLY EXECUTION ITEMS</div>

      <div class="card">
        <div class="filters">
          <div class="seg" aria-label="time lens">
            <button class="active" data-lens="year">ì—°ì°¨</button>
            <button data-lens="half">ë°˜ê¸°</button>
            <button data-lens="quarter">ë¶„ê¸°</button>
            <button data-lens="month">ì›”</button>
            <button data-lens="week">ì£¼</button>
          </div>

          <select class="select" id="period-select" title="ê¸°ê°„ ì„ íƒ"></select>

          <select class="select" id="status-select" title="ìƒíƒœ">
            <option value="all">ì „ì²´</option>
            <option value="open">ë¯¸ì™„ë£Œ</option>
            <option value="done">ì™„ë£Œ</option>
          </select>

          <input class="input" id="search-input" placeholder="ê²€ìƒ‰ (ID/ì—…ë¬´/ì‚°ì¶œë¬¼/Step)" />
          <span class="badge" id="count-badge">0 items</span>
        </div>

        <div class="chipbar" id="dept-chips"></div>
      </div>

      <div class="card wbs-wrap">
        <table class="wbs">
          <thead>
            <tr>
              <th style="width: 52px">DONE</th>
              <th style="width: 92px">ID</th>
              <th>ì—…ë¬´(1í–‰)</th>
              <th style="width: 560px">ì£¼ì°¨ë³„ ì„¸ë¶€ ì‹¤í–‰ í•­ëª© (Step ì²´í¬/ê°€ì¤‘ì¹˜/ì™„ë£Œì¼)</th>
              <th style="width: 150px">DUE (D-â—‹ì¼)</th>
              <th style="width: 120px">ì‚°ì¶œë¬¼</th>
            </tr>
          </thead>
          <tbody id="wbs-body"></tbody>
        </table>
      </div>

      <div id="reg" class="section-title"><span>ğŸ§¾</span> ê¸°ëŠ¥ë¶„ë¦¬Â·ì¸í—ˆê°€</div>
      <div class="grid-2">
        <div class="card">
          <div style="font-weight: 900; font-size: 13px; margin-bottom: 10px">ê¸°ëŠ¥ë¶„ë¦¬(ì´ˆì•ˆ)</div>
          <table class="dark">
            <thead>
              <tr>
                <th style="width: 18%">ëª¨ë“ˆ</th>
                <th style="width: 18%">ì‚¬ìš©ì</th>
                <th style="width: 22%">ì¶œë ¥</th>
                <th style="width: 22%">í†µì œ í¬ì¸íŠ¸</th>
                <th style="width: 20%">ë¦¬ìŠ¤í¬</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><b>ë°ì´í„° ë³´ê¸°</b></td><td>ì˜ë£Œì§„Â·ë³´í˜¸ì</td><td>ì›ìë£Œ/ìš”ì•½</td><td>í‘œì‹œí•­ëª©/ì„ê³„ì¹˜ ì„¤ì •</td><td>ì €ìœ„í—˜ ê°€ëŠ¥ì„±</td></tr>
              <tr><td><b>ì´ìƒ íƒì§€</b></td><td>ì˜ë£Œì§„</td><td>score/flag</td><td>í™•ì •ë¬¸êµ¬ ê¸ˆì§€/ê·¼ê±°ë¡œê·¸</td><td>ìƒí–¥ ê°€ëŠ¥ì„±</td></tr>
              <tr><td><b>íŠ¸ë¦¬ì•„ì œ</b></td><td>ë³´í˜¸ì</td><td>í–‰ë™ê¶Œê³ </td><td>ë¬¸êµ¬/ê¸°ì¤€ ì˜ë£Œì§„ ìŠ¹ì¸</td><td>ìƒí–¥ ê°€ëŠ¥ì„±â†‘</td></tr>
              <tr><td><b>LLM ê°€ì´ë“œ</b></td><td>ë³´í˜¸ì</td><td>êµìœ¡/FAQ</td><td>ê²€ìˆ˜/ê¸ˆì¹™ì–´/ê°€ë“œë ˆì¼</td><td>ì˜¤ë‚¨ìš© ë°©ì§€</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <div style="font-weight: 900; font-size: 13px; margin-bottom: 10px">ì œì¶œìë£Œ ì°¨ë“±(ê°€ì •)</div>
          <table class="dark">
            <thead>
              <tr>
                <th style="width: 34%">í•­ëª©</th>
                <th style="width: 33%">Class I ê°€ì •</th>
                <th style="width: 33%">Class II ê°€ì •</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><b>SW ì„¤ëª…/ë²„ì „</b></td><td>ê¸°ëŠ¥ëª©ë¡/ë¡œê·¸</td><td>ì•„í‚¤í…ì²˜/ì¶”ì ì„±</td></tr>
              <tr><td><b>ìœ„í—˜ê´€ë¦¬</b></td><td>í•µì‹¬ ìœ„í—˜ ì¤‘ì‹¬</td><td>íŠ¸ë¦¬ì•„ì œ/ì•ŒëŒ ê°•í™”</td></tr>
              <tr><td><b>ì„±ëŠ¥/ê·¼ê±°</b></td><td>ë‚´ë¶€+ì œí•œí‰ê°€</td><td>ì™¸ë¶€/êµì°¨ê²€ì¦ ê°•í™”</td></tr>
              <tr><td><b>ë³´ì•ˆ/SBOM</b></td><td>ê¸°ë³¸ í†µì œ</td><td>ìœ„í˜‘ëª¨ë¸/ì·¨ì•½ì  ê°•í™”</td></tr>
              <tr><td><b>ì‚¬ìš©ì í•©ì„±</b></td><td>í•µì‹¬ íë¦„</td><td>ì‘ê¸‰ ë¶„ê¸° ì¤‘ì‹¬ ê°•í™”</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      /* =========================
        CONFIG
      ========================= */
      const YEAR = 2026;
      const STORAGE_KEY = "aitrics_2026_roadmap_step_weighted";
      const EDIT_PASSWORD = "1234";

      /* =========================
        Utilities
      ========================= */
      const MONTH_MAP = { Jan:1, Feb:2, Mar:3, Apr:4, May:5, Jun:6, Jul:7, Aug:8, Sep:9, Oct:10, Nov:11, Dec:12 };
      const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
      const pad2 = (n)=>String(n).padStart(2,"0");
      const fmtDate = (d)=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

      function todayStr(){
        const d = new Date();
        d.setHours(0,0,0,0);
        return fmtDate(d);
      }
      function firstMondayOfMonth(year, month) {
        const d = new Date(year, month - 1, 1);
        const day = d.getDay(); // 0 Sun ... 1 Mon ... 6 Sat
        const diff = day === 0 ? 1 : day === 1 ? 0 : 8 - day;
        d.setDate(d.getDate() + diff);
        return d;
      }
      function dueLabelToDate(dueLabel) {
        const m = dueLabel?.match(/^([A-Za-z]{3})\s+W(\d)$/);
        if (!m) return null;
        const mon = MONTH_MAP[m[1]];
        const w = Number(m[2]);
        if (!mon || !w) return null;
        const startMon = firstMondayOfMonth(YEAR, mon);
        const weekStart = new Date(startMon);
        weekStart.setDate(startMon.getDate() + (w - 1) * 7);
        const due = new Date(weekStart);
        due.setDate(weekStart.getDate() + 4); // Friday
        return due;
      }
      function dDayString(dueDate) {
        if (!dueDate) return "D-?";
        const today = new Date(); today.setHours(0,0,0,0);
        const due = new Date(dueDate); due.setHours(0,0,0,0);
        const diff = Math.round((due - today) / 86400000);
        return diff >= 0 ? `D-${diff}ì¼` : `D+${Math.abs(diff)}ì¼`;
      }
      function quarterOfDate(d) {
        const m = d.getMonth() + 1;
        if (m <= 3) return "Q1";
        if (m <= 6) return "Q2";
        if (m <= 9) return "Q3";
        return "Q4";
      }
      function halfOfDate(d) { return d.getMonth() + 1 <= 6 ? "H1" : "H2"; }
      function monthKey(d) { return `${YEAR}-${pad2(d.getMonth() + 1)}`; }
      function lensKey(lens, task) {
        const due = task.dueDate;
        if (!due) return "UNKNOWN";
        if (lens === "year") return String(YEAR);
        if (lens === "half") return halfOfDate(due);
        if (lens === "quarter") return quarterOfDate(due);
        if (lens === "month") return monthKey(due);
        if (lens === "week") return task.dueLabel || "UNKNOWN";
        return "ALL";
      }
      function lensLabel(lens, key) {
        if (lens === "year") return `${key}ë…„`;
        if (lens === "half") return key === "H1" ? "ìƒë°˜ê¸°(H1)" : "í•˜ë°˜ê¸°(H2)";
        if (lens === "quarter") return `ë¶„ê¸° ${key}`;
        if (lens === "month") return `${key.split("-")[1]}ì›”`;
        if (lens === "week") return key;
        return key;
      }
      function parseDueMonth(dueLabel){
        const m = dueLabel?.match(/^([A-Za-z]{3})\s+W(\d)$/);
        if (!m) return null;
        return m[1]; // e.g. "Feb"
      }
      function stepKeyForTask(task, step){
        const mon = parseDueMonth(task.dueLabel) || "UNK";
        const wk = step.week || "W?";
        return `${mon} ${wk}`; // "Feb W1"
      }

      /* =========================
        Step weight rules (ê¸°ë³¸)
        - ì„œë²„/ì¸í”„ë¼ ê³„ì—´: 50%
        - ë¬¸ì„œ/ê°€ì´ë“œ/ìŠ¤í™: 10%
        - ë‚˜ë¨¸ì§€: ê· ë“± ë¶„ë°°
      ========================= */
      function defaultWeightForStepLabel(label){
        const s = (label||"").toLowerCase();
        // ì„œë²„ / ì¸í”„ë¼
        if (s.includes("ì„œë²„") || s.includes("gpu") || s.includes("ì¸í”„ë¼") || s.includes("ë„¤íŠ¸ì›Œí¬") || s.includes("ë°©í™”ë²½") || s.includes("os") || s.includes("driver") || s.includes("ë“œë¼ì´ë²„")) return 50;
        // ë¬¸ì„œ
        if (s.includes("ë¬¸ì„œ") || s.includes("ê°€ì´ë“œ") || s.includes("spec") || s.includes("ìŠ¤í™") || s.includes("ë³´ê³ ì„œ") || s.includes("í…œí”Œë¦¿") || s.includes("ì ˆì°¨") || s.includes("ê¸°ë¡")) return 10;
        return null;
      }
      function ensureSteps(task){
        // steps ì—†ìœ¼ë©´ 1ê°œë¡œ ìƒì„±
        if (!Array.isArray(task.steps) || task.steps.length === 0){
          task.steps = [{ week: "W1", label: "ì„¸ë¶€ í•­ëª© ì •ì˜ í•„ìš”", weight: 100, done: !!task.checked, doneAt: task.checked ? todayStr() : null }];
          return;
        }
        // step schema normalize
        task.steps.forEach((st)=>{
          if (typeof st.done !== "boolean") st.done = false;
          if (!("doneAt" in st)) st.doneAt = null;
          // weight set
          const w = Number(st.weight);
          if (!Number.isFinite(w) || w <= 0){
            const dw = defaultWeightForStepLabel(st.label);
            st.weight = dw != null ? dw : 0; // temporary, will normalize later
          }
        });

        // normalize weights: if any 0 remain, distribute leftover or equalize
        const fixed = task.steps.filter(s => Number(s.weight) > 0).reduce((a,s)=>a+Number(s.weight),0);
        const zeros = task.steps.filter(s => !(Number(s.weight) > 0));
        if (zeros.length > 0){
          // target total 100
          const remain = Math.max(0, 100 - fixed);
          const each = zeros.length ? Math.floor(remain / zeros.length) : 0;
          zeros.forEach((s, idx)=>{
            s.weight = each;
          });
          // distribute remainder
          let rem2 = remain - each*zeros.length;
          let i=0;
          while(rem2>0 && i<zeros.length){
            zeros[i].weight += 1;
            rem2 -= 1;
            i++;
          }
        }

        // if sum != 100, scale proportionally
        const sum = task.steps.reduce((a,s)=>a+Number(s.weight||0),0);
        if (sum > 0 && sum !== 100){
          task.steps.forEach((s)=>{ s.weight = Math.round((Number(s.weight||0)/sum)*100); });
          // fix rounding drift
          let ssum = task.steps.reduce((a,s)=>a+Number(s.weight||0),0);
          while (ssum !== 100){
            // adjust largest step
            const idx = task.steps.reduce((best,iStep,idx,arr)=>{
              const w = Number(iStep.weight||0);
              return w > Number(arr[best].weight||0) ? idx : best;
            },0);
            if (ssum > 100){ task.steps[idx].weight -= 1; ssum -= 1; }
            else { task.steps[idx].weight += 1; ssum += 1; }
          }
        }

        // if legacy task.checked true, mark all steps done (but keep doneAt if already set)
        if (task.checked){
          task.steps.forEach((s)=>{
            if (!s.done){
              s.done = true;
              s.doneAt = s.doneAt || todayStr();
            }
          });
        } else {
          // if all steps done, sync checked
          const allDone = task.steps.every(s=>!!s.done);
          if (allDone) task.checked = true;
        }
      }

      function taskProgress(task){
        ensureSteps(task);
        const totalW = task.steps.reduce((a,s)=>a+Number(s.weight||0),0) || 0;
        if (totalW <= 0) return 0;
        const doneW = task.steps.filter(s=>s.done).reduce((a,s)=>a+Number(s.weight||0),0);
        return clamp(Math.round((doneW/totalW)*100),0,100);
      }
      function groupProgress(group){
        let total=0, done=0;
        group.tasks.forEach(t=>{
          ensureSteps(t);
          const tw = t.steps.reduce((a,s)=>a+Number(s.weight||0),0);
          total += tw;
          done += t.steps.filter(s=>s.done).reduce((a,s)=>a+Number(s.weight||0),0);
        });
        if (!total) return 0;
        return clamp(Math.round((done/total)*100),0,100);
      }

      /* =========================
        Default Data (ì‚¬ìš©ì ê¸°ë³¸ìë£Œ ê¸°ë°˜)
      ========================= */
      const DEFAULT_DATA = {
        kpiSnapshot: [
          { name: "Vent ë°ì´í„° ì´ìƒì¹˜ ê²€ì¦", progress: 20, due: "May", owner: "ì„¸ë¸Œë€ìŠ¤", note: "ëª©í‘œ: ~5ì›”" },
          { name: "PRO ì„¤ë¬¸ ë°ì´í„° ê²€ì¦", progress: 10, due: "Jun", owner: "ì„¸ë¸Œë€ìŠ¤Â·AITRICS", note: "ëª©í‘œ: ~6ì›”" },
          { name: "ì•…í™”/ì´ìƒ ì‹œê·¸ë„ ë ˆì´ë¸”ë§", progress: 0, due: "May", owner: "ì„¸ë¸Œë€ìŠ¤", note: "ëª©í‘œ: ~5ì›”" }
        ],
        roadmap: [
          {
            dept: "ë°ì´í„°/ì¸í”„ë¼ ì—°ê³„",
            color: "var(--data)",
            category: "DATA PIPELINE",
            tasks: [
              {
                id: "D-1.1",
                text: "GPU ì„œë²„ ë° ì›Œí¬ìŠ¤í…Œì´ì…˜ ì¸í”„ë¼ êµ¬ì¶•",
                out: "ì„¤ì¹˜ê³µë¬¸",
                checked: true,
                dueLabel: "Feb W1",
                steps: [
                  { week: "W1", label: "ì„œë²„ ì…ê³  í™•ì¸" },
                  { week: "W1", label: "OS/ë“œë¼ì´ë²„ ì„¸íŒ…" },
                  { week: "W2", label: "ì›ë‚´ ë„¤íŠ¸ì›Œí¬/ë°©í™”ë²½ ì—°ê³„" }
                ]
              },
              {
                id: "D-1.2",
                text: "EMR/MDIP ë°ì´í„° ì—°ê³„ í™•ì¸",
                out: "ì ‘ê·¼ê¶Œí•œ",
                checked: true,
                dueLabel: "Feb W2",
                steps: [
                  { week: "W2", label: "EMR í…Œì´ë¸”Â·ë³€ìˆ˜ ë§µí•‘" },
                  { week: "W3", label: "MDIP ì—°ë™ ì¸í„°í˜ì´ìŠ¤ í…ŒìŠ¤íŠ¸" },
                  { week: "W3", label: "ì¶”ì¶œ ë¡œê·¸/ì—ëŸ¬ì½”ë“œ í‘œì¤€í™”" }
                ]
              },
              {
                id: "D-1.3",
                text: "T-Bridge ë°ì´í„° ì¸í„°í˜ì´ìŠ¤ ì„¤ê³„",
                out: "API_Spec",
                checked: false,
                dueLabel: "Mar W4",
                steps: [
                  { week: "W1", label: "ì¥ë¹„ ì‹ í˜¸ ìˆ˜ì§‘ ê·œê²© ì •ì˜" },
                  { week: "W3", label: "ìŠ¤íŠ¸ë¦¬ë°/ë°°ì¹˜ API ì„¤ê³„" },
                  { week: "W4", label: "ì—ëŸ¬Â·ì¬ì „ì†¡Â·ëˆ„ë½ ì²˜ë¦¬ ì •ì˜" }
                ]
              },
              {
                id: "D-1.4",
                text: "ì´ìƒì¹˜/ê²°ì¸¡ ì²˜ë¦¬ ë° ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ ê°œë°œ",
                out: "Pipeline",
                checked: false,
                dueLabel: "May W4",
                steps: [
                  { week: "W2", label: "ê²°ì¸¡ì¹˜ ì²˜ë¦¬ ê·œì¹™/ë³´ê°„ ì •ì±…" },
                  { week: "W3", label: "ì´ìƒì¹˜ ì •ì˜Â·í”Œë˜ê·¸ ì²´ê³„" },
                  { week: "W4", label: "íŒŒì´í”„ë¼ì¸ ì„±ëŠ¥/ì¬í˜„ì„± ìµœì í™”" }
                ]
              }
            ]
          },
          {
            dept: "AI ì•Œê³ ë¦¬ì¦˜ ê°œë°œ",
            color: "var(--ai)",
            category: "AI MODELING",
            tasks: [
              {
                id: "A-2.1",
                text: "ì•…í™”/ì´ìƒ ì‹œê·¸ë„ ë ˆì´ë¸”ë§ ê¸°ì¤€ ìˆ˜ë¦½",
                out: "Label_Guide",
                checked: false,
                dueLabel: "Mar W2",
                steps: [
                  { week: "W1", label: "ì˜ë£Œì§„ í•©ì˜ ê¸°ì¤€ ì´ˆì•ˆ" },
                  { week: "W2", label: "ë ˆì´ë¸”ë§ ë„êµ¬/ì›Œí¬í”Œë¡œìš° ê²°ì •" },
                  { week: "W2", label: "ì¼ì¹˜ë„(IAA) ì ê²€ ì„¤ê³„" }
                ]
              },
              {
                id: "A-2.2",
                text: "Vent ì›ì²œë°ì´í„° ìƒ˜í”Œ EDA ë° íŠ¹ì§•ì •ì˜",
                out: "EDA_Report",
                checked: false,
                dueLabel: "Mar W4",
                steps: [
                  { week: "W2", label: "ì‹ í˜¸ í’ˆì§ˆ ë¶„í¬/ê²°ì¸¡ íŒ¨í„´ ë¶„ì„" },
                  { week: "W3", label: "ì„ìƒ ì´ë²¤íŠ¸ í›„ë³´ í”¼ì²˜ ì •ì˜" },
                  { week: "W4", label: "ëª¨ë¸ ì…ë ¥ í…ì„œ ìŠ¤í™ í™•ì •" }
                ]
              },
              {
                id: "A-2.3",
                text: "Transformer ê¸°ë°˜ ì‹œê³„ì—´ ëª¨ë¸ + Agent êµ¬ì¡° ì„¤ê³„",
                out: "Arch_v1",
                checked: false,
                dueLabel: "May W2",
                steps: [
                  { week: "W2", label: "ì‹œê³„ì—´ ëª¨ë¸ baseline ì •ì˜" },
                  { week: "W3", label: "Agent I/OÂ·ë¡œê·¸ ìŠ¤í‚¤ë§ˆ" },
                  { week: "W4", label: "ì„ê³„ì¹˜/ë¶ˆí™•ì‹¤ì„± ì²˜ë¦¬ ë£°" }
                ]
              }
            ]
          },
          {
            dept: "ì„œë¹„ìŠ¤ ê°œë°œ/êµ¬í˜„",
            color: "var(--svc)",
            category: "SERVICE/UX",
            tasks: [
              {
                id: "P-3.1",
                text: "ë³´í˜¸ì ì¸í„°ë·° ë° ë‹ˆì¦ˆ ë¶„ì„(íŠ¸ë¦¬ì•„ì œ 3ë‹¨ê³„ í¬í•¨)",
                out: "FGI_Report",
                checked: false,
                dueLabel: "Mar W4",
                steps: [
                  { week: "W2", label: "ëŒ€ìƒì ì„ ì •/ë™ì˜ ì ˆì°¨ ì •ë¦¬" },
                  { week: "W4", label: "FGI ìˆ˜í–‰Â·í˜ì¸í¬ì¸íŠ¸ ë„ì¶œ" }
                ]
              },
              {
                id: "P-3.2",
                text: "íŠ¸ë¦¬ì•„ì œ 3ë‹¨ê³„ UX ë¬¸êµ¬ ì„¤ê³„",
                out: "Flowchart",
                checked: false,
                dueLabel: "Apr W4",
                steps: [
                  { week: "W2", label: "ë¶„ê¸° íŠ¸ë¦¬(ë³´ìˆ˜ì ) ì´ˆì•ˆ" },
                  { week: "W3", label: "ì˜ë£Œì§„ ë¬¸êµ¬/ê¸ˆì¹™ì–´ ê²€ìˆ˜" },
                  { week: "W4", label: "ì‚¬ìš©ì í•©ì„± ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±" }
                ]
              },
              {
                id: "P-3.3",
                text: "UI ê¸°íš ë° PRO í•­ëª©/ì£¼ê¸° ì„¤ê³„",
                out: "Figma",
                checked: false,
                dueLabel: "May W4",
                steps: [
                  { week: "W2", label: "í™”ë©´ íë¦„ë„(Wireframe) ì‘ì„±" },
                  { week: "W3", label: "PRO ë¬¸í•­Â·ì…ë ¥ì£¼ê¸° ì„¤ê³„" },
                  { week: "W4", label: "Figma ìƒì„¸ í”„ë¡œí† íƒ€ì…" }
                ]
              }
            ]
          },
          {
            dept: "ì¸í—ˆê°€/í’ˆì§ˆ(RA/QA)",
            color: "var(--reg)",
            category: "REGULATORY",
            tasks: [
              {
                id: "R-4.1",
                text: "SaMD ì‚¬ì „ìƒë‹´ íŒ¨í‚¤ì§€(ì˜ë„ëœ ì‚¬ìš©Â·ë“±ê¸‰Â·ê¸°ëŠ¥ë¶„ë¦¬)",
                out: "Q&A_Doc",
                checked: false,
                dueLabel: "Mar W4",
                steps: [
                  { week: "W2", label: "ì˜ë„ëœ ì‚¬ìš©/ì‚¬ìš©ì/ì¶œë ¥ ë¬¸êµ¬ í™•ì •" },
                  { week: "W3", label: "ê¸°ëŠ¥ë¶„ë¦¬ ì‹œë‚˜ë¦¬ì˜¤Â·ë¦¬ìŠ¤í¬ ìš”ì•½" },
                  { week: "W4", label: "íšŒì˜ ìˆ˜í–‰Â·í•©ì˜ì‚¬í•­ ê¸°ë¡" }
                ]
              },
              {
                id: "R-4.2",
                text: "SW ìˆ˜ëª…ì£¼ê¸°Â·ì¶”ì ì„±Â·ì‹œí—˜ì „ëµ ë¬¸ì„œí™”",
                out: "Dev_QMS",
                checked: false,
                dueLabel: "Jun W4",
                steps: [
                  { week: "W2", label: "ìš”êµ¬ì‚¬í•­-ì„¤ê³„-ì‹œí—˜ ì¶”ì ì„± í…œí”Œë¦¿" },
                  { week: "W3", label: "V&V ê³„íš" },
                  { week: "W4", label: "ë¦´ë¦¬ì¦ˆ/ë³€ê²½ê´€ë¦¬ ì ˆì°¨" }
                ]
              },
              {
                id: "R-4.3",
                text: "ê¸°ìˆ ë¬¸ì„œ íŒ¨í‚¤ì§•(ì„±ëŠ¥Â·ìœ„í—˜ê´€ë¦¬Â·ì‚¬ìš©ì í•©ì„±) ì´ˆì•ˆ",
                out: "Tech_File",
                checked: false,
                dueLabel: "Dec W2",
                steps: [
                  { week: "W1", label: "ì„±ëŠ¥í‰ê°€ ê²°ê³¼ì„œ í†µí•©" },
                  { week: "W2", label: "ìœ„í—˜ê´€ë¦¬Â·ê°€ë“œë ˆì¼ ê·¼ê±° ì •ë¦¬" }
                ]
              }
            ]
          }
        ]
      };

      function loadData() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return structuredClone(DEFAULT_DATA);
          return JSON.parse(raw);
        } catch (e) {
          return structuredClone(DEFAULT_DATA);
        }
      }
      function saveLocal() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA));
        markSaved();
      }

      /* =========================
        State
      ========================= */
      let DATA = loadData();
      let editMode = false;

      let lens = "year";
      let periodKey = String(YEAR);
      let statusFilter = "all";
      let searchQuery = "";
      let deptFilter = new Set();

      let ganttView = "month"; // month|week

      function hydrateDueDates(){
        DATA.roadmap.forEach((g)=>{
          g.tasks.forEach((t)=>{
            t._dueObj = dueLabelToDate(t.dueLabel);
            t._dueStr = t._dueObj ? fmtDate(t._dueObj) : null;
            ensureSteps(t);
          });
        });
      }
      hydrateDueDates();

      /* =========================
        Save badge
      ========================= */
      function markSaved() {
        const b = document.getElementById("save-badge");
        const now = new Date();
        const hh = pad2(now.getHours()), mm = pad2(now.getMinutes());
        b.textContent = `SAVED ${hh}:${mm}`;
        b.classList.remove("warn");
        b.classList.add("on");
      }
      function markDirty() {
        const b = document.getElementById("save-badge");
        b.textContent = "NOT SAVED";
        b.classList.remove("on");
        b.classList.add("warn");
      }

      /* =========================
        Overview / Total (step-weighted)
      ========================= */
      function renderOverview() {
        const grid = document.getElementById("overview-grid");
        grid.innerHTML = "";

        const catOrder = ["DATA PIPELINE", "AI MODELING", "SERVICE/UX", "REGULATORY"];
        const catColor = {
          "DATA PIPELINE": "var(--data)",
          "AI MODELING": "var(--ai)",
          "SERVICE/UX": "var(--svc)",
          "REGULATORY": "var(--reg)"
        };

        const cats = {};
        catOrder.forEach((c)=>cats[c] = { doneW:0, totalW:0 });

        DATA.roadmap.forEach((g)=>{
          g.tasks.forEach((t)=>{
            ensureSteps(t);
            const tw = t.steps.reduce((a,s)=>a+Number(s.weight||0),0);
            const dw = t.steps.filter(s=>s.done).reduce((a,s)=>a+Number(s.weight||0),0);
            if (!cats[g.category]) cats[g.category] = { doneW:0, totalW:0 };
            cats[g.category].doneW += dw;
            cats[g.category].totalW += tw;
          });
        });

        catOrder.forEach((c)=>{
          const totalW = cats[c].totalW;
          const pct = totalW ? Math.round((cats[c].doneW/totalW)*100) : 0;
          // done/total counts (tasks) for reference
          const tasks = DATA.roadmap.filter(g=>g.category===c).flatMap(g=>g.tasks);
          const doneTasks = tasks.filter(t=>taskProgress(t)===100).length;
          const el = document.createElement("div");
          el.className = "p-card";
          el.innerHTML = `
            <div class="p-top">
              <div class="p-name">${c}</div>
              <div class="p-meta">${pct}%<br/><span>${doneTasks}/${tasks.length}</span></div>
            </div>
            <div class="p-bar"><div class="p-fill" style="width:${pct}%; background:${catColor[c]};"></div></div>
            <div class="p-foot">
              <span class="pill">SCOPE: 2026</span>
              <span class="pill">${lensLabel(lens, periodKey)}</span>
            </div>
          `;
          grid.appendChild(el);
        });
      }

      function renderTotal(){
        let totalW=0, doneW=0;
        DATA.roadmap.forEach((g)=>{
          g.tasks.forEach((t)=>{
            ensureSteps(t);
            totalW += t.steps.reduce((a,s)=>a+Number(s.weight||0),0);
            doneW += t.steps.filter(s=>s.done).reduce((a,s)=>a+Number(s.weight||0),0);
          });
        });
        const pct = totalW ? Math.round((doneW/totalW)*100) : 0;
        document.getElementById("total-val").innerText = `${pct}%`;
      }

      /* =========================
        KPI table
      ========================= */
      function renderKPI(){
        const body = document.getElementById("kpi-body");
        body.innerHTML = "";
        DATA.kpiSnapshot.forEach((k, idx)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="${editMode ? "editable" : ""}" data-k="name" data-i="${idx}">${k.name}</span></td>
            <td class="mono"><span class="${editMode ? "editable" : ""}" data-k="progress" data-i="${idx}">${clamp(Number(k.progress)||0,0,100)}</span>%</td>
            <td><span class="${editMode ? "editable" : ""}" data-k="due" data-i="${idx}">${k.due}</span></td>
            <td>
              <span class="${editMode ? "editable" : ""}" data-k="owner" data-i="${idx}">${k.owner}</span>
              <span style="color:var(--text-s)"> Â· </span>
              <span class="${editMode ? "editable" : ""}" data-k="note" data-i="${idx}">${k.note}</span>
            </td>
          `;
          body.appendChild(tr);
        });

        body.querySelectorAll("[data-k]").forEach((el)=>{
          el.contentEditable = editMode ? "true" : "false";
          el.setAttribute("contenteditable", editMode ? "true" : "false");
          if (editMode){
            el.onblur = ()=>{
              const i = Number(el.dataset.i);
              const key = el.dataset.k;
              const v = el.textContent.trim();
              if (key === "progress"){
                DATA.kpiSnapshot[i][key] = clamp(Number(v.replace(/[^0-9.]/g,""))||0,0,100);
                el.textContent = DATA.kpiSnapshot[i][key];
              } else {
                DATA.kpiSnapshot[i][key] = v || DATA.kpiSnapshot[i][key];
              }
              markDirty();
            };
          } else {
            el.onblur = null;
          }
        });
      }

      /* =========================
        Filters
      ========================= */
      function getAllTasks(){
        const list=[];
        DATA.roadmap.forEach((g)=>g.tasks.forEach((t)=>list.push({t,g})));
        return list;
      }
      function buildPeriods(){
        const keys = new Set();
        getAllTasks().forEach(({t})=>{
          const key = lensKey(lens, { dueDate: t._dueObj, dueLabel: t.dueLabel });
          keys.add(key);
        });

        let list = Array.from(keys);
        if (lens === "year") list = [String(YEAR)];
        else if (lens === "half") list = ["H1","H2"].filter(k=>keys.has(k));
        else if (lens === "quarter") list = ["Q1","Q2","Q3","Q4"].filter(k=>keys.has(k));
        else if (lens === "month") list.sort();
        else if (lens === "week"){
          list.sort((a,b)=>{
            const da = dueLabelToDate(a), db = dueLabelToDate(b);
            if (da && db) return da - db;
            return String(a).localeCompare(String(b));
          });
        }

        const sel = document.getElementById("period-select");
        sel.innerHTML = "";
        list.forEach((k)=>{
          const opt = document.createElement("option");
          opt.value = k;
          opt.textContent = lensLabel(lens, k);
          sel.appendChild(opt);
        });

        if (!list.includes(periodKey)) periodKey = list[0] || String(YEAR);
        sel.value = periodKey;
      }

      function renderDeptChips(){
        const wrap = document.getElementById("dept-chips");
        wrap.innerHTML = "";

        const all = document.createElement("div");
        all.className = "chip " + (deptFilter.size===0 ? "on" : "");
        all.textContent = "ì „ì²´";
        all.onclick = ()=>{ deptFilter.clear(); renderAll(); };
        wrap.appendChild(all);

        DATA.roadmap.forEach((g)=>{
          const chip = document.createElement("div");
          chip.className = "chip " + (deptFilter.has(g.dept) ? "on" : "");
          chip.textContent = g.dept;
          chip.onclick = ()=>{
            if (deptFilter.has(g.dept)) deptFilter.delete(g.dept);
            else deptFilter.add(g.dept);
            renderAll();
          };
          wrap.appendChild(chip);
        });
      }

      function passesFilters(t,g){
        if (deptFilter.size>0 && !deptFilter.has(g.dept)) return false;

        const tp = taskProgress(t);
        if (statusFilter === "open" && tp === 100) return false;
        if (statusFilter === "done" && tp !== 100) return false;

        if (searchQuery){
          const stepText = (t.steps||[]).map(s=>s.label).join(" ");
          const hay = `${t.id} ${t.text} ${t.out} ${t.dueLabel} ${stepText}`.toLowerCase();
          if (!hay.includes(searchQuery.toLowerCase())) return false;
        }

        const key = lensKey(lens, { dueDate: t._dueObj, dueLabel: t.dueLabel });
        if (key !== periodKey) return false;

        return true;
      }

      /* =========================
        Year-end risk: 12ì›” due + ë¯¸ì™„(100% ë¯¸ë§Œ)
      ========================= */
      function isYearEndOverdue(task){
        if (!task._dueObj) return false;
        const month = task._dueObj.getMonth(); // 0=Jan ... 11=Dec
        return month === 11 && taskProgress(task) < 100;
      }

      /* =========================
        WBS render (step-based)
      ========================= */
      function renderWBS(){
        const body = document.getElementById("wbs-body");
        body.innerHTML = "";
        let cnt=0;

        DATA.roadmap.forEach((g,gIdx)=>{
          const rows = g.tasks.filter(t=>passesFilters(t,g));
          if (rows.length===0) return;

          const trh = document.createElement("tr");
          trh.className = "dept-row";
          trh.innerHTML = `<td colspan="6"><span class="dept-tag" style="background:${g.color};">DEPT</span>${g.dept} <span class="mono" style="color:var(--text-s); font-size:11px;">Â· ${groupProgress(g)}%</span></td>`;
          body.appendChild(trh);

          rows.forEach((t)=>{
            cnt++;
            ensureSteps(t);
            const dueObj = t._dueObj || dueLabelToDate(t.dueLabel);
            const dday = dDayString(dueObj);
            const dueDateStr = dueObj ? fmtDate(dueObj) : "UNKNOWN";
            const tp = taskProgress(t);

            const stepsHtml = (t.steps||[]).map((s,i)=>{
              const doneAt = s.doneAt ? s.doneAt : "-";
              return `
                <div class="stepline">
                  <input class="scb" type="checkbox" ${s.done ? "checked" : ""} data-role="stepDone" data-g="${gIdx}" data-id="${t.id}" data-si="${i}">
                  <span class="wtag">${stepKeyForTask(t,s)}</span>
                  <span class="${editMode ? "editable" : ""}" data-role="stepLabel" data-g="${gIdx}" data-id="${t.id}" data-si="${i}">${s.label}</span>
                  <span class="${editMode ? "editable" : ""} wtpill" data-role="stepWeight" data-g="${gIdx}" data-id="${t.id}" data-si="${i}" style="margin-left:auto">${Number(s.weight||0)}%</span>
                  <span class="datepill">${doneAt}</span>
                </div>
              `;
            }).join("");

            const tr = document.createElement("tr");
            if (tp === 100) tr.classList.add("doneRow");
            if (isYearEndOverdue(t)) tr.classList.add("year-end-risk");

            tr.innerHTML = `
              <td><input class="cb" type="checkbox" ${tp === 100 ? "checked" : ""} data-role="taskDone" data-g="${gIdx}" data-id="${t.id}"></td>
              <td class="idcell mono" style="color:${g.color}; font-weight:900;">
                <span class="${editMode ? "editable" : ""}" data-role="id" data-g="${gIdx}" data-id="${t.id}">${t.id}</span>
              </td>
              <td>
                <div class="${tp===100 ? "doneText" : ""} ${editMode ? "editable" : ""}" data-role="text" data-g="${gIdx}" data-id="${t.id}" style="font-weight:900;">
                  <span class="text-val">${t.text}</span>
                  ${isYearEndOverdue(t) ? '<span class="risk-badge" contenteditable="false">âš  ì—°ë§ ë¯¸ì™„</span>' : ""}
                </div>
                <div class="mono" style="margin-top:6px; color:var(--text-s); font-size:10px;">
                  STEP PROGRESS: <b style="color:var(--text-p)">${tp}%</b>
                </div>
              </td>
              <td class="steps">${stepsHtml || "-"}</td>
              <td>
                <span class="duetag">${dday}</span>
                <span class="duemeta">
                  <span class="${editMode ? "editable" : ""}" data-role="dueLabel" data-g="${gIdx}" data-id="${t.id}">${t.dueLabel}</span>
                  Â· <span class="mono">${dueDateStr}</span>
                </span>
              </td>
              <td><span class="outtag ${editMode ? "editable" : ""}" data-role="out" data-g="${gIdx}" data-id="${t.id}">${t.out}</span></td>
            `;
            body.appendChild(tr);
          });
        });

        document.getElementById("count-badge").textContent = `${cnt} items`;

        // Task checkbox: mark all steps
        body.querySelectorAll('input[data-role="taskDone"]').forEach((cb)=>{
          cb.onchange = ()=>{
            const gIdx = Number(cb.dataset.g);
            const id = cb.dataset.id;
            const task = DATA.roadmap[gIdx].tasks.find(x=>x.id===id);
            if (!task) return;
            ensureSteps(task);

            const now = todayStr();
            if (cb.checked){
              task.steps.forEach(s=>{ s.done = true; s.doneAt = s.doneAt || now; });
              task.checked = true;
            } else {
              task.steps.forEach(s=>{ s.done = false; s.doneAt = null; });
              task.checked = false;
            }
            hydrateDueDates();
            markDirty();
            renderAll(false);
          };
        });

        // Step checkbox: update step + auto date
        body.querySelectorAll('input[data-role="stepDone"]').forEach((cb)=>{
          cb.onchange = ()=>{
            const gIdx = Number(cb.dataset.g);
            const id = cb.dataset.id;
            const si = Number(cb.dataset.si);
            const task = DATA.roadmap[gIdx].tasks.find(x=>x.id===id);
            if (!task) return;
            ensureSteps(task);
            const step = task.steps[si];
            if (!step) return;

            if (cb.checked){
              step.done = true;
              step.doneAt = step.doneAt || todayStr();
            } else {
              step.done = false;
              step.doneAt = null;
            }

            // sync task.checked
            const allDone = task.steps.every(s=>s.done);
            task.checked = allDone;

            markDirty();
            renderAll(false);
          };
        });

        // Inline edits (text/out/due/id/stepLabel/stepWeight)
        body.querySelectorAll("[data-role]").forEach((el)=>{
          const role = el.dataset.role;
          // checkboxes already handled
          if (role === "taskDone" || role === "stepDone") return;

          const editable = editMode && (role !== "stepDone") ? "true" : "false";
          el.contentEditable = editable;
          el.setAttribute("contenteditable", editable);

          if (editMode){
            el.onblur = ()=>applyEdit(el);
          } else {
            el.onblur = null;
          }
        });
      }

      function applyEdit(el){
        const role = el.dataset.role;
        const gIdx = Number(el.dataset.g);
        const id = el.dataset.id;
        const group = DATA.roadmap[gIdx];
        if (!group) return;

        const task = group.tasks.find(x=>x.id===id);
        if (!task) return;

        const v = el.textContent.trim();

        if (role === "text"){
          const tv = el.querySelector(".text-val");
          const cleaned = (tv ? tv.textContent : el.textContent).trim();
          task.text = cleaned || task.text;
          markDirty();
          return;
        }
        if (role === "out"){
          task.out = v || task.out;
          markDirty();
          return;
        }
        if (role === "dueLabel"){
          task.dueLabel = v || task.dueLabel;
          hydrateDueDates();
          markDirty();
          return;
        }
        if (role === "id"){
          if (v && v !== task.id){
            const exists = group.tasks.some(x=>x.id===v);
            if (!exists){
              task.id = v;
              markDirty();
            } else {
              el.textContent = task.id;
            }
          }
          return;
        }
        if (role === "stepLabel"){
          const si = Number(el.dataset.si);
          ensureSteps(task);
          if (task.steps[si]){
            task.steps[si].label = v || task.steps[si].label;
            // if weight was auto and still 0 or irrelevant, keep; else no change
            markDirty();
            renderAll(false);
          }
          return;
        }
        if (role === "stepWeight"){
          const si = Number(el.dataset.si);
          ensureSteps(task);
          if (!task.steps[si]) return;
          const n = clamp(Number(v.replace(/[^0-9.]/g,""))||0, 1, 100);
          task.steps[si].weight = n;
          // re-normalize to 100
          const sum = task.steps.reduce((a,s)=>a+Number(s.weight||0),0);
          if (sum !== 100 && sum > 0){
            task.steps.forEach((s)=>{ s.weight = Math.round((Number(s.weight||0)/sum)*100); });
            let ssum = task.steps.reduce((a,s)=>a+Number(s.weight||0),0);
            while (ssum !== 100){
              const idx = task.steps.reduce((best,cur,idx,arr)=> Number(cur.weight||0) > Number(arr[best].weight||0) ? idx : best, 0);
              if (ssum > 100){ task.steps[idx].weight -= 1; ssum -= 1; }
              else { task.steps[idx].weight += 1; ssum += 1; }
            }
          }
          markDirty();
          renderAll(false);
          return;
        }
      }

      /* =========================
        Gantt (month/week) â€” step ê¸°ë°˜ ì§„í–‰ë¥  ì±„ì›€
        - í•œ ì¤„ = Task
        - í•´ë‹¹ ì›”/ì£¼ ì¹¸ì— ë°”(ë°°ê²½) + ì§„í–‰ fillì„ í‘œì‹œ
          * month view: task due month ì¹¸ì— bar í‘œì‹œ (progress fill)
          * week view: task stepsê°€ ì†í•œ "Mon Wk" ì¹¸ì— bar í‘œì‹œ (í•´ë‹¹ stepì´ doneì´ë©´ fill 100%, ì•„ë‹ˆë©´ 0%)
      ========================= */
      function getMonthColumns(){
        // 2026-02 ~ 2026-12 (ê¸°ì¡´ íƒ€ì„ë¼ì¸ ì‹œì‘ì´ 2ì›”ì´ì—ˆìŒ)
        const months = [];
        for (let m=2; m<=12; m++){
          months.push({ key: `${YEAR}-${pad2(m)}`, label: pad2(m) });
        }
        return months;
      }
      function getWeekColumns(){
        // ëª¨ë“  taskì˜ due month ê¸°ë°˜ìœ¼ë¡œ, W1~W4
        const months = ["Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        const cols = [];
        months.forEach(mon=>{
          for (let w=1; w<=4; w++){
            cols.push({ key: `${mon} W${w}`, label: `${mon} W${w}` });
          }
        });
        return cols;
      }

      function renderGantt(){
        const head = document.getElementById("gantt-head");
        const body = document.getElementById("gantt-body");
        head.innerHTML = "";
        body.innerHTML = "";

        const cols = ganttView === "month" ? getMonthColumns() : getWeekColumns();

        // head
        const tr1 = document.createElement("tr");
        tr1.className = "gantt-head-row";
        tr1.innerHTML = `<th class="gantt-left">TASK</th>` + cols.map(c=>`<th class="g-tick">${c.label}</th>`).join("");
        head.appendChild(tr1);

        // rows
        DATA.roadmap.forEach((g)=>{
          // dept separator
          const sep = document.createElement("tr");
          sep.innerHTML = `<td colspan="${cols.length+1}" style="background:rgba(255,255,255,0.02); font-weight:900; color:var(--text-p);">
            <span class="dept-tag" style="background:${g.color};">DEPT</span>${g.dept}
            <span class="mono" style="color:var(--text-s); font-size:11px;"> Â· ${groupProgress(g)}%</span>
          </td>`;
          body.appendChild(sep);

          g.tasks.forEach((t)=>{
            ensureSteps(t);
            const tp = taskProgress(t);
            const tr = document.createElement("tr");

            const left = document.createElement("td");
            left.className = "gantt-left";
            left.innerHTML = `
              <div class="g-label">
                <div>
                  <div class="g-title" style="color:${g.color}">${t.id}</div>
                  <div style="font-weight:900;">${t.text}</div>
                </div>
                <div class="g-meta">${tp}%</div>
              </div>
            `;
            tr.appendChild(left);

            cols.forEach((c)=>{
              const td = document.createElement("td");
              td.className = "g-cell";

              let showBar = false;
              let fillPct = 0;
              let barColor = g.color;

              if (ganttView === "month"){
                const due = t._dueObj || dueLabelToDate(t.dueLabel);
                if (due){
                  const key = monthKey(due);
                  if (key === c.key){
                    showBar = true;
                    fillPct = tp;
                  }
                }
              } else {
                // week: show each step in its own cell (mon+wk)
                const step = t.steps.find(s=>stepKeyForTask(t,s)===c.key);
                if (step){
                  showBar = true;
                  fillPct = step.done ? 100 : 0;
                }
              }

              if (showBar){
                td.innerHTML = `<div class="g-bar"><div class="g-fill" style="width:${fillPct}%; background:${barColor};"></div></div>`;
              } else {
                td.innerHTML = "";
              }
              tr.appendChild(td);
            });

            body.appendChild(tr);
          });
        });
      }

      /* =========================
        Controls: lens, filters, edit mode, gantt view
      ========================= */
      function initControls(){
        // lens buttons
        document.querySelectorAll('.seg[aria-label="time lens"] button').forEach((btn)=>{
          btn.onclick = ()=>{
            document.querySelectorAll('.seg[aria-label="time lens"] button').forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            lens = btn.dataset.lens;
            buildPeriods();
            renderAll();
          };
        });

        document.getElementById("period-select").onchange = (e)=>{ periodKey = e.target.value; renderAll(); };
        document.getElementById("status-select").onchange = (e)=>{ statusFilter = e.target.value; renderAll(); };
        document.getElementById("search-input").oninput = (e)=>{ searchQuery = e.target.value || ""; renderAll(); };

        // gantt view buttons
        document.querySelectorAll('.seg[aria-label="gantt view"] button').forEach((btn)=>{
          btn.onclick = ()=>{
            document.querySelectorAll('.seg[aria-label="gantt view"] button').forEach(b=>b.classList.remove("active"));
            btn.classList.add("active");
            ganttView = btn.dataset.gview;
            renderGantt();
          };
        });

        // edit flow (no popup)
        const editBtn = document.getElementById("edit-btn");
        const saveBtn = document.getElementById("save-btn");
        const exitBtn = document.getElementById("exit-btn");
        const pwRow = document.getElementById("pw-row");
        const pwInput = document.getElementById("pw-input");
        const pwOk = document.getElementById("pw-ok");
        const pwCancel = document.getElementById("pw-cancel");
        const modeBadge = document.getElementById("mode-badge");

        editBtn.onclick = ()=>{ pwRow.style.display="flex"; pwInput.value=""; pwInput.focus(); };
        pwCancel.onclick = ()=>{ pwRow.style.display="none"; pwInput.value=""; pwInput.placeholder="ë¹„ë°€ë²ˆí˜¸(1234)"; };
        pwOk.onclick = ()=>{
          if (pwInput.value !== EDIT_PASSWORD){
            pwInput.value = "";
            pwInput.placeholder = "ë¹„ë°€ë²ˆí˜¸ ë¶ˆì¼ì¹˜";
            return;
          }
          pwRow.style.display = "none";
          editMode = true;
          modeBadge.textContent = "EDITING";
          modeBadge.classList.add("on");
          editBtn.style.display = "none";
          saveBtn.style.display = "inline-block";
          exitBtn.style.display = "inline-block";
          renderAll(false);
        };

        saveBtn.onclick = ()=>{ saveLocal(); };
        exitBtn.onclick = ()=>{
          editMode = false;
          modeBadge.textContent = "READ-ONLY";
          modeBadge.classList.remove("on");
          editBtn.style.display = "inline-block";
          saveBtn.style.display = "none";
          exitBtn.style.display = "none";
          renderAll(false);
        };
      }

      /* =========================
        Render all
      ========================= */
      function renderAll(rebuildPeriods=true){
        if (rebuildPeriods) buildPeriods();
        renderDeptChips();
        renderTotal();
        renderOverview();
        renderKPI();
        renderWBS();
        renderGantt();
      }

      /* =========================
        Boot
      ========================= */
      initControls();
      buildPeriods();
      renderAll();
    </script>
  </body>
</html>
